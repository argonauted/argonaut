<!DOCTYPE html>
<html>
	<head>
		<title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="module">
            //import ElectronNodeFileAccess from "../dist/ElectronNodeFileAccess.js"
            //new ElectronNodeFileAccess()
        </script>

        <script type="text/javacript">
            function getIsDirty() {
                return false
            }
        </script>

        <script type="text/javascript" src="../dist/dummy.js"></script>
        <script>
            console.log(foo(4))

            let eventHandle
            let eventIndex = 0
            let firstPass = true
            let continueEvents = true

            let dummyCmd = {scope: 'rpc', method: 'console_input', params: ["111","",0]}
            let commands = [
                {scope: 'rpc', method: 'console_input', params: ["n <- 100","",0]},
                {scope: 'rpc', method: 'console_input', params: ["x <- rnorm(n)","",0]},
                {scope: 'rpc', method: 'console_input', params: ["x","",0]},
                {scope: 'rpc', method: 'console_input', params: ["plot(1:n,x)","",0]},
                {scope: 'rpc', method: 'execute_code', params: ["n <- 34"]},
                {scope: 'rpc', method: 'execute_code', params: ["print(n)"]},
                {scope: 'rpc', method: 'execute_code', params: ["y <- c(\"sadfasd\",\"hgfhgf\",\"dtrdtrd\")"]},
                {scope: 'rpc', method: 'execute_r_code', params: ["y <- 342342"]},
                {scope: 'rpc', method: 'execute_code', params: ["y <- y + 342343"]},
                {scope: 'rpc', method: 'get_object_contents', params: ["y"]},
                {scope: 'rpc', method: 'console_input', params: ["y"]},
                {scope: 'rpc', method: 'execute_r_code', params: ["paste(\"[\",paste(c(\"asdf\",\"nnnn\",\"ffff\"),collapse=\",\"),\"]\",sep=\"\")"]}
            ]

            function run() {
                console.log("In run!")
                
                if(firstPass) {
                    //send a dummy command
                    sendCommand(dummyCmd)
                }

                //start event listener
                listenForEvents()
            }

            function onInitComplete() {
                let cmdIndex = 0
                let runCommands = () => {
                    if(cmdIndex < commands.length) {
                        console.log("Sending command: " + JSON.stringify(commands[cmdIndex]))
                        sendCommand(commands[cmdIndex])
                        cmdIndex++
                        setTimeout(runCommands,1000)
                    }
                    else {
                        console.log("Commands completed!")
                    }
                }
                runCommands()
            }

            const EVENT_DELAY = 10 //this is thrown in just because
            function onEventCompleted() {
                if(continueEvents) {
                    setTimeout(listenForEvents,EVENT_DELAY)
                }
            }

            function listenForEvents() {
                try {
                    getEvents();
                }
                catch(err) {
                    console.log("Error in event listener loop!")
                    console.log(err.toString())
                    //issue another event request
                    onEventCompleted()
                }
            }

            function pauseEvents() {
                continueEvents = false;
            }

            //-------------------------
            // RPC and Other Requests
            //-------------------------

            function getEvents() {
                let scope = "events"
                let method = "get_events"
                let params = [eventIndex]
                rSessionApi.sendRpcRequest(scope,method,params).then(response => {
                    let dt = new Date()
                    console.log(`Event response - ${dt.getMinutes()}-${dt.getSeconds()}.${dt.getMilliseconds()}`)
                    if(response.data.result) {
                        response.data.result.forEach( (entry,index) => {
                            
                            console.log(`type: ${entry.type}, index: ${index}`)
                            console.log(JSON.stringify(entry))

                            if(entry.type == "deferred_init_completed") {
                                console.log("Init Complete!")
                                onInitComplete()
                            }
                            else if(entry.type == "plots_state_changed") {
                                let plotFileName = entry.data.filename
                                rSessionApi.getBinary(plotFileName).then(response => {
                                        console.log("Graphics file received:")
                                        console.log(JSON.stringify(response))   
                                })
                                .catch(err => {
                                    console.error("Error getting graphics file:")
                                    console.error(err.toString())
                                })
                            }

                            // else if(entry.type == "console_output") {
                            //     console.log("console output:")
                            //     console.log(entry.data.text)
                            // }
                            // // else if(entry.type == "console_wite_prompt") {
                            // //     console.log("console prompt:")
                            // //     console.log(entry.data)
                            // // }
                            // else if(entry.type == "console_write_input") {
                            //     console.log("console input:")
                            //     console.log(entry.data.text)
                            // }
                           
                            // else {
                            //     console.log("Unkown: " + entry.type)
                            //     console.log(JSON.stringify(entry))
                            // }

                            eventIndex = entry.id
                            console.log("Index set to " + eventIndex)
                        })
                    }
                    else {
                        //console.log("Empty result in events")
                    }

                    onEventCompleted()
                }).catch(e => {
                    if(e) console.log(e.toString())
                    else console.log("Unknown error in request")

                    onEventCompleted()
                })
            }

            function sendCommand(cmd) {
                rSessionApi.sendRpcRequest(cmd.scope,cmd.method,cmd.params).then(response => {
                    console.log("Command response: " + JSON.stringify(response))
                })
            }


        </script>

	</head>
	<body>
        <p>This is the application!</p>
        <button onclick="run()">Start</button>
        <button onclick="pauseEvents()">Pause Events</button>
	</body>
</html>